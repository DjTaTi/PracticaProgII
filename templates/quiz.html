<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Practica Parcial Programacion II - TUP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .question { margin-bottom: 18px; padding: 10px; border-bottom: 1px solid #ddd; }
    .qtext { font-weight: bold; }
    .opts { margin-top: 6px; }
    .submit { margin-top: 16px; }
    .small { font-size: 0.9em; color: #666; }
    .correct { background: #e6ffea; border-left: 4px solid #2ca02c; padding: 4px; }
    .incorrect { background: #ffecec; border-left: 4px solid #d9534f; padding: 4px; }
    .choice { font-weight: bold; }
    .legend { margin-bottom: 12px; }
    .disabled-label { color: #333; }
    input[type="radio"][disabled], input[type="checkbox"][disabled] { cursor: default; }
  </style>
</head>
<body>
  <h1>Practica Parcial Programacion II - TUP</h1>
  <p class="small">Se muestran {{ questions|length }} preguntas seleccionadas al azar.</p>

  {% if review and summary %}
    <div class="legend">
      <p><strong>Resultado:</strong> {{ summary.total }} / {{ summary.max_score }} ({{ '%.1f'|format(summary.percent) }}%)</p>
      <p>Archivo de resultados guardado: <a href="{{ url_for('get_result_file', filename=summary.result_file) }}">{{ summary.result_file }}</a></p>
      <p class="small">En la revisión, las respuestas correctas aparecen en verde; tus elecciones incorrectas en rojo.</p>
    </div>
  {% endif %}

  <form method="post" action="{{ url_for('submit') }}">
    {% for q in questions %}
      <div class="question">
        <div class="qtext">{{ loop.index }}. {{ q.question }}</div>
        <div class="opts">
          {% set is_multi = (q.correct_display | length) > 1 %}
          {% set safe_id = q.id | replace('.', '_') %}
          {% for opt in q.options %}
            {% set opt_idx = loop.index0 %}
            {% set input_name = "q_" ~ q.id %}
            {% set checked = false %}
            {% set is_correct = (opt_idx in q.correct_display) %}
            {% if review %}
              {# obtener los datos de chosen desde details_map usando el texto de la pregunta como clave #}
              {% set detail = details_map.get(q.question) if details_map is defined else None %}
              {% if detail %}
                {% set checked = (opt_idx in detail.chosen) %}
              {% endif %}
            {% endif %}

            <div
              {% if review %}
                class="{% if is_correct %}correct{% elif checked and not is_correct %}incorrect{% endif %}"
              {% endif %}
            >
              {% if is_multi %}
                <input type="checkbox"
                       id="q{{ safe_id }}_{{ opt_idx }}"
                       name="{{ input_name }}"
                       value="{{ opt_idx }}"
                       {% if review %} disabled {% endif %}
                       {% if checked %} checked {% endif %}>
              {% else %}
                <input type="radio"
                       id="q{{ safe_id }}_{{ opt_idx }}"
                       name="{{ input_name }}"
                       value="{{ opt_idx }}"
                       {% if review %} disabled {% endif %}
                       {% if checked %} checked {% endif %}>
              {% endif %}
              <label for="q{{ safe_id }}_{{ opt_idx }}" class="disabled-label">
                {{ 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[opt_idx] }}. {{ opt }}
                {% if review and is_correct %}
                  <span class="small"> — correcta</span>
                {% endif %}
                {% if review and checked and not is_correct %}
                  <span class="small"> — tu elección</span>
                {% endif %}
              </label>
            </div>
          {% endfor %}
        </div>
        {# Hidden field with the correct displayed indices so server can grade reliably #}
        <input type="hidden" name="correct_{{ q.id }}" value="{{ q.correct_display | join(',') }}">
      </div>
    {% endfor %}

    {% if not review %}
      <div class="submit">
        <button type="submit">Enviar respuestas y calificar</button>
      </div>
    {% else %}
      <div class="submit">
        <a href="{{ url_for('quiz') }}"><button type="button">Realizar otro intento (nuevo examen)</button></a>
      </div>
    {% endif %}
  </form>
</body>
</html>