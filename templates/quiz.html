<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Practica Parcial Programacion II - TUP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .question { margin-bottom: 18px; padding: 10px; border-bottom: 1px solid #ddd; }
    .qtext { font-weight: bold; }
    .opts { margin-top: 6px; }
    .submit { margin-top: 16px; }
    .small { font-size: 0.9em; color: #666; }
    .correct { background: #e6ffea; border-left: 4px solid #2ca02c; padding: 4px; }
    .incorrect { background: #ffecec; border-left: 4px solid #d9534f; padding: 4px; }
    .choice { font-weight: bold; }
    .legend { margin-bottom: 12px; }
    .disabled-label { color: #333; }
    input[type="radio"][disabled], input[type="checkbox"][disabled] { cursor: default; }
    
    /* Estilos para validación */
    .question-error { 
      border-left: 4px solid #dc3545; 
      background-color: #f8d7da; 
    }
    .error-message {
      color: #dc3545;
      font-size: 0.9em;
      margin-top: 8px;
      padding: 8px;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      display: none;
    }
    .submit-disabled {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>Practica Parcial Programacion II - TUP</h1>
  <p class="small">Se muestran {{ questions|length }} preguntas seleccionadas al azar.</p>
  
  <div id="validation-error" class="error-message">
    <strong>¡Atención!</strong> Debes responder todas las preguntas antes de enviar el cuestionario.
  </div>

  {% if review and summary %}
    <div class="legend">
      <p><strong>Resultado:</strong> {{ summary.total }} / {{ summary.max_score }} ({{ '%.1f'|format(summary.percent) }}%)</p>
      <p>Archivo de resultados guardado: <a href="{{ url_for('get_result_file', filename=summary.result_file) }}">{{ summary.result_file }}</a></p>
      <p class="small">En la revisión, las respuestas correctas aparecen en verde; tus elecciones incorrectas en rojo.</p>
    </div>
  {% endif %}

  <form id="quiz-form" method="post" action="{{ url_for('submit') }}">>
    {% for q in questions %}
      <div class="question">
        <div class="qtext">{{ loop.index }}. {{ q.question }}</div>
        <div class="opts">
          {% set is_multi = (q.correct_display | length) > 1 %}
          {% set safe_id = q.id | replace('.', '_') %}
          {% for opt in q.options %}
            {% set opt_idx = loop.index0 %}
            {% set input_name = "q_" ~ q.id %}
            {% set checked = false %}
            {% set is_correct = (opt_idx in q.correct_display) %}
            {% if review %}
              {# obtener los datos de chosen desde details_map usando el texto de la pregunta como clave #}
              {% set detail = details_map.get(q.question) if details_map is defined else None %}
              {% if detail %}
                {% set checked = (opt_idx in detail.chosen) %}
              {% endif %}
            {% endif %}

            <div
              {% if review %}
                class="{% if is_correct %}correct{% elif checked and not is_correct %}incorrect{% endif %}"
              {% endif %}
            >
              {% if is_multi %}
                <input type="checkbox"
                       id="q{{ safe_id }}_{{ opt_idx }}"
                       name="{{ input_name }}"
                       value="{{ opt_idx }}"
                       {% if review %} disabled {% endif %}
                       {% if checked %} checked {% endif %}>
              {% else %}
                <input type="radio"
                       id="q{{ safe_id }}_{{ opt_idx }}"
                       name="{{ input_name }}"
                       value="{{ opt_idx }}"
                       {% if review %} disabled {% endif %}
                       {% if checked %} checked {% endif %}>
              {% endif %}
              <label for="q{{ safe_id }}_{{ opt_idx }}" class="disabled-label">
                {{ 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[opt_idx] }}. {{ opt }}
                {% if review and is_correct %}
                  <span class="small"> — correcta</span>
                {% endif %}
                {% if review and checked and not is_correct %}
                  <span class="small"> — tu elección</span>
                {% endif %}
              </label>
            </div>
          {% endfor %}
        </div>
        {# Hidden field with the correct displayed indices so server can grade reliably #}
        <input type="hidden" name="correct_{{ q.id }}" value="{{ q.correct_display | join(',') }}">
      </div>
    {% endfor %}

    {% if not review %}
      <div class="submit">
        <button type="submit">Enviar respuestas y calificar</button>
      </div>
    {% else %}
      <div class="submit">
        <a href="{{ url_for('quiz') }}"><button type="button">Realizar otro intento (nuevo examen)</button></a>
      </div>
    {% endif %}
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('quiz-form');
      const errorMessage = document.getElementById('validation-error');
      
      if (form) {
        form.addEventListener('submit', function(event) {
          // Solo validar si no estamos en modo review
          {% if not review %}
          if (!validateAllQuestionsAnswered()) {
            event.preventDefault();
            showValidationError();
            return false;
          }
          {% endif %}
        });
      }

      function validateAllQuestionsAnswered() {
        const questions = document.querySelectorAll('.question');
        let allAnswered = true;
        
        questions.forEach(function(questionDiv, index) {
          const inputs = questionDiv.querySelectorAll('input[type="radio"], input[type="checkbox"]');
          const questionId = inputs.length > 0 ? inputs[0].name : null;
          
          if (questionId) {
            const answeredInputs = questionDiv.querySelectorAll(`input[name="${questionId}"]:checked`);
            
            // Remover clase de error primero
            questionDiv.classList.remove('question-error');
            
            if (answeredInputs.length === 0) {
              questionDiv.classList.add('question-error');
              allAnswered = false;
            }
          }
        });
        
        return allAnswered;
      }

      function showValidationError() {
        errorMessage.style.display = 'block';
        // Scroll al mensaje de error
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Ocultar el mensaje después de 5 segundos
        setTimeout(function() {
          errorMessage.style.display = 'none';
        }, 5000);
      }

      // Validación en tiempo real - opcional
      const inputs = document.querySelectorAll('input[type="radio"], input[type="checkbox"]');
      inputs.forEach(function(input) {
        input.addEventListener('change', function() {
          // Remover error de la pregunta actual cuando se selecciona una respuesta
          const questionDiv = this.closest('.question');
          if (questionDiv) {
            questionDiv.classList.remove('question-error');
          }
          
          // Ocultar mensaje de error si todas las preguntas están respondidas
          if (validateAllQuestionsAnswered()) {
            errorMessage.style.display = 'none';
          }
        });
      });
    });
  </script>
</body>
</html>